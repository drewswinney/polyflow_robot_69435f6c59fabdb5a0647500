/dts-v1/;
/plugin/;

/ {
    compatible = "raspberrypi,4-model-b", "brcm,bcm2711";

    /*
     * CAN0: MCP2518FD on SPI0.0, interrupt on GPIO25
     * CAN1: MCP2518FD on SPI1.0, interrupt on GPIO24
     *
     * Mode A per Waveshare docs:
     *  - can0 on spi0.0
     *  - can1 on spi1.0
     */

    /* SPI0 + CAN0 ------------------------------------------------------ */
    fragment@0 {
        target = <&spi>;
        __overlay__ {
            status = "okay";

            #address-cells = <1>;
            #size-cells    = <0>;

            /* Wire up MOSI/MISO/SCLK/CE0/CE1 */
            pinctrl-names = "default";
            pinctrl-0     = <&spi0_gpio7>;

            /* Explicit chip selects: CE0 on GPIO8, CE1 on GPIO7 */
            cs-gpios = <&gpio 8 1  &gpio 7 1>;

            can0: mcp251xfd@0 {
                compatible = "microchip,mcp251xfd";
                reg = <0>;
                spi-max-frequency = <20000000>;

                clocks = <&can0_osc>;
                clock-names = "osc";

                /* IRQ on GPIO25 */
                interrupt-parent = <&gpio>;
                interrupts = <25 2>;

                pinctrl-names = "default";
                pinctrl-0     = <&can0_int_pins>;
            };
        };
    };

    /* SPI1 + CAN1 ------------------------------------------------------ */
    fragment@1 {
        target = <&spi1>;
        __overlay__ {
            status = "okay";

            #address-cells = <1>;
            #size-cells    = <0>;

            /* Use existing aux SPI1 pinmux group */
            pinctrl-names = "default";
            pinctrl-0     = <&spi1_gpio16>;

            /*
             * CAN1 controller on SPI1 chip select 0
             */
            can1: mcp251xfd@0 {
                compatible = "microchip,mcp251xfd";
                reg = <0>;

                spi-max-frequency = <20000000>;

                clocks = <&can1_osc>;
                clock-names = "osc";

                /* Interrupt on GPIO24 (board pin 18) */
                interrupt-parent = <&gpio>;
                interrupts = <24 2>;

                pinctrl-names = "default";
                pinctrl-0     = <&can1_int_pins>;
            };
        };
    };

    /* GPIO pin configuration for the interrupt lines ------------------- */
    fragment@2 {
        target = <&gpio>;
        __overlay__ {

            can0_int_pins: can0_int_pins {
                brcm,pins     = <25>;
                brcm,function = <0>;  /* input */
                brcm,pull     = <0>;  /* no pull */
            };

            can1_int_pins: can1_int_pins {
                brcm,pins     = <24>;
                brcm,function = <0>;  /* input */
                brcm,pull     = <0>;  /* no pull */
            };
        };
    };

    /* Fixed-clock nodes for the MCP2518FD oscillators ------------------ */
    fragment@3 {
        target-path = "/";
        __overlay__ {

            can0_osc: can0_osc {
                compatible = "fixed-clock";
                #clock-cells = <0>;
                clock-frequency = <40000000>; /* adjust if your HAT uses a different crystal */
            };

            can1_osc: can1_osc {
                compatible = "fixed-clock";
                #clock-cells = <0>;
                clock-frequency = <40000000>;
            };
        };
    };
};
